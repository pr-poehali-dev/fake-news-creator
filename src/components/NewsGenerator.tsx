
import { useEffect, useState } from "react";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { CalendarIcon, Clock, Globe, ThumbsUp, BookOpen, AlertCircle } from "lucide-react";

// Типы для новостей
type NewsItem = {
  id: number;
  title: string;
  description: string;
  category: string;
  source: string;
  readTime: number;
  importance: number;
};

// Функция для детерминированной генерации псевдослучайного числа на основе входной строки
function hashCode(str: string): number {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return hash;
}

// Функция для получения случайного элемента из массива на основе seed
function getRandomItem<T>(array: T[], seed: string): T {
  const randomIndex = Math.abs(hashCode(`${seed}-${array.length}`)) % array.length;
  return array[randomIndex];
}

// Функция для получения нескольких уникальных случайных элементов из массива
function getMultipleRandomItems<T>(array: T[], count: number, seed: string): T[] {
  if (count >= array.length) return [...array]; // Если запрошено больше элементов, чем есть в массиве

  const result: T[] = [];
  const usedIndices = new Set<number>();
  
  for (let i = 0; i < count; i++) {
    let randomIndex: number;
    do {
      randomIndex = Math.abs(hashCode(`${seed}-attempt-${i}-${usedIndices.size}`)) % array.length;
    } while (usedIndices.has(randomIndex));
    
    usedIndices.add(randomIndex);
    result.push(array[randomIndex]);
  }
  
  return result;
}

export const NewsGenerator = ({ date }: { date: string }) => {
  const [news, setNews] = useState<NewsItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    setLoading(true);
    try {
      // Имитация загрузки данных
      setTimeout(() => {
        const generatedNews = generateNews(date);
        setNews(generatedNews);
        setLoading(false);
      }, 800);
    } catch (err) {
      setError("Произошла ошибка при генерации новостей");
      setLoading(false);
    }
  }, [date]);

  // Определяем эпоху на основе года
  const getEpochType = (year: number): 'ancient' | 'pre-industrial' | 'industrial' | 'modern' | 'near-future' | 'far-future' => {
    if (year < 1800) return 'ancient';
    if (year < 1900) return 'pre-industrial';
    if (year < 1980) return 'industrial';
    if (year < 2023) return 'modern';
    if (year < 2100) return 'near-future';
    return 'far-future';
  };

  // Генерирует фейковые новости на основе даты
  const generateNews = (dateString: string): NewsItem[] => {
    const [day, month, yearStr] = dateString.split('.');
    const year = parseInt(yearStr);
    const epochType = getEpochType(year);
    
    // Новостные сюжеты для разных эпох
    const newsByEpoch = {
      'ancient': {
        titles: [
          "Построен новый колодец в центре города",
          "Кузнец изобрел новый способ ковки мечей",
          "Открыт новый торговый путь в восточные земли",
          "Фермер вывел новый сорт пшеницы с высоким урожаем",
          "Лекарь обнаружил целебные свойства местных трав",
          "Построена новая мельница на реке",
          "Мастер создал самые точные песочные часы",
          "Изобретен новый плуг для вспашки земли",
          "Открыто месторождение глины высокого качества",
          "Новый метод выделки кожи увеличил срок её службы",
          "Портной представил новый способ плетения тканей",
          "Рыбаки построили лодку нового типа",
          "Городской сад пополнился редкими растениями",
          "Изобретен новый способ консервации продуктов",
          "Новый тип масляных ламп стал ярче и экономичнее"
        ],
        descriptions: [
          "Местные жители собрались, чтобы отпраздновать это важное событие, которое значительно облегчит их жизнь.",
          "Мастер трудился несколько лет, чтобы усовершенствовать своё ремесло, и теперь готов поделиться знаниями.",
          "После долгих месяцев испытаний результаты превзошли все ожидания, вызвав всеобщее одобрение.",
          "Это небольшое, но важное улучшение может изменить жизнь всей общины к лучшему.",
          "Люди уже выстраиваются в очередь, чтобы своими глазами увидеть это новшество.",
          "Это изобретение позволит сэкономить много времени и сил, которые раньше тратились на рутинный труд.",
          "Хотя некоторые скептически отнеслись к новинке, первые испытания показали ее преимущества.",
          "Несколько богатых горожан уже заказали себе такое изделие, несмотря на высокую цену.",
          "Мастер использовал старинные знания, которые были почти забыты в наше время.",
          "Это улучшение, хоть и кажется незначительным, сделает важное дело более эффективным."
        ],
        categories: ["Ремесло", "Строительство", "Сельское хозяйство", "Торговля", "Медицина", "Быт"],
        sources: ["Городской глашатай", "Письмо странника", "Записи летописца", "Рассказы путешественников"]
      },
      'pre-industrial': {
        titles: [
          "Изобретен новый метод производства стекла",
          "Построена первая в городе паровая мельница",
          "Разработан улучшенный ткацкий станок",
          "Печатник создал новый пресс для книг",
          "Часовщик представил самые точные часы в стране",
          "Первая городская газовая лампа зажглась на главной площади",
          "Открыт новый способ очистки питьевой воды",
          "Изобретен метод консервации продуктов в стеклянных банках",
          "Создан новый тип музыкального инструмента",
          "Построен первый чугунный мост через реку",
          "Представлен новый метод производства бумаги",
          "Открыта первая городская библиотека",
          "Улучшен процесс выплавки металлов",
          "Создана новая система канализации",
          "Разработан более эффективный способ добычи угля"
        ],
        descriptions: [
          "Это изобретение обещает снизить стоимость производства и сделать товар доступнее для простых людей.",
          "Городские власти выразили поддержку этому начинанию, выделив средства на дальнейшее развитие.",
          "После нескольких месяцев испытаний результаты показали двукратное увеличение производительности.",
          "Хотя некоторые гильдии выразили опасения, большинство ремесленников приветствуют прогресс.",
          "Изобретение может значительно улучшить условия труда, снизив физическую нагрузку на работников.",
          "Первые образцы уже поступили в продажу и вызвали большой интерес у публики.",
          "Проект потребовал значительных инвестиций, но обещает быстро окупиться.",
          "В других странах подобные технологии уже используются, но наше исполнение имеет ряд преимуществ.",
          "Изобретатель работал над своим детищем более десяти лет, постоянно совершенствуя конструкцию.",
          "В следующем году планируется расширение производства для удовлетворения растущего спроса."
        ],
        categories: ["Промышленность", "Транспорт", "Городская инфраструктура", "Наука", "Образование"],
        sources: ["Городской вестник", "Научный журнал", "Промышленная газета", "Записки исследователя"]
      },
      'industrial': {
        titles: [
          "Запущена первая линия электрического трамвая",
          "Изобретен новый метод переработки нефти",
          "Создан первый промышленный холодильник",
          "Разработана новая модель телефонного аппарата",
          "Испытан первый дизельный двигатель для судов",
          "Открыта новая технология производства стали",
          "Представлен первый автомобиль местного производства",
          "Создана новая система очистки промышленных стоков",
          "Разработан улучшенный метод радиосвязи",
          "Построена крупнейшая в регионе электростанция",
          "Изобретен новый тип фотоаппарата с автоматической фокусировкой",
          "Налажено производство синтетических красителей",
          "Представлена первая модель пишущей машинки с русским шрифтом",
          "Изобретен новый метод консервации продуктов",
          "Создан прототип механического калькулятора"
        ],
        descriptions: [
          "Новая технология значительно снизит себестоимость производства и повысит конкурентоспособность отечественной промышленности.",
          "Испытания показали двукратное увеличение эффективности по сравнению с существующими аналогами.",
          "Правительство выделило значительные средства на внедрение этой разработки в массовое производство.",
          "Ученые работали над этим проектом более пяти лет, преодолевая множество технических трудностей.",
          "Ожидается, что в течение двух лет технология станет доступна широкому потребителю.",
          "Иностранные специалисты уже выразили интерес к приобретению лицензии на производство.",
          "Несмотря на скептицизм консервативной части общества, новшество быстро завоевывает популярность.",
          "Это изобретение может стать ключевым для развития целой отрасли промышленности.",
          "На международной выставке разработка получила золотую медаль и признание экспертов.",
          "Первые образцы будут доступны только состоятельным гражданам, но в перспективе цена должна снизиться."
        ],
        categories: ["Энергетика", "Транспорт", "Связь", "Промышленность", "Технологии"],
        sources: ["Технический вестник", "Промышленные новости", "Инженерный журнал", "Научный обозреватель"]
      },
      'modern': {
        titles: [
          "Разработан новый процессор с рекордной производительностью",
          "Создан прорывной метод лечения диабета",
          "Запущен новый спутник связи для глобального интернет-покрытия",
          "Представлен электромобиль с рекордным запасом хода",
          "Ученые разработали новый метод опреснения морской воды",
          "Создан первый квантовый компьютер для коммерческого использования",
          "Изобретена новая технология 3D-печати органов",
          "Разработана вакцина против опасного вируса",
          "Представлен смартфон с гибким экраном нового поколения",
          "Создан новый суперматериал с уникальными свойствами",
          "Открыт революционный метод хранения энергии",
          "Разработана система предсказания землетрясений",
          "Представлен искусственный интеллект для диагностики заболеваний",
          "Создан первый коммерческий дрон для доставки грузов",
          "Изобретен новый метод переработки пластиковых отходов"
        ],
        descriptions: [
          "Эта технология может произвести революцию в своей области, открывая новые возможности для человечества.",
          "Международная команда исследователей работала над проектом в условиях строжайшей секретности более трех лет.",
          "Крупнейшие компании мира уже выстроились в очередь, чтобы инвестировать в эту разработку.",
          "Технология прошла все необходимые испытания и готова к внедрению в массовое производство уже в следующем году.",
          "Эксперты предсказывают, что эта инновация может изменить целую индустрию в течение ближайших пяти лет.",
          "Первые результаты применения технологии превзошли даже самые оптимистичные прогнозы разработчиков.",
          "Проект получил рекордное финансирование от венчурных фондов, что подтверждает его перспективность.",
          "Хотя некоторые эксперты выражают скептицизм, большинство научного сообщества высоко оценивает потенциал разработки.",
          "Это изобретение может стать ключом к решению одной из глобальных проблем человечества.",
          "В ближайшие месяцы планируется провести масштабное тестирование в реальных условиях."
        ],
        categories: ["Технологии", "Медицина", "Экология", "Искусственный интеллект", "Энергетика", "Космос"],
        sources: ["Tech Review", "Science Today", "Инновационный вестник", "Digital Trends", "Medical Journal"]
      },
      'near-future': {
        titles: [
          "Разработана система прямого нейронного интерфейса для управления компьютером",
          "Создан первый коммерческий квантовый компьютер с миллионом кубитов",
          "Запущена первая частная космическая станция на орбите Луны",
          "Представлен искусственный интеллект с сознанием уровня человека",
          "Создан первый работающий прототип термоядерного реактора",
          "Разработан метод полного восстановления повреждённого спинного мозга",
          "Представлена технология телепортации квантовых состояний на дальние расстояния",
          "Создан самовосстанавливающийся биосинтетический материал",
          "Запущены первые автономные подводные города",
          "Разработана технология полной регенерации человеческих органов",
          "Создан первый летающий автомобиль для массового рынка",
          "Представлена система полного погружения в виртуальную реальность",
          "Изобретен экологически чистый метод производства синтетического мяса",
          "Разработана технология извлечения CO2 из атмосферы в промышленных масштабах",
          "Создан первый надежный переводчик с языка животных"
        ],
        descriptions: [
          "Эта технология может стать поворотным моментом в истории человечества, изменив наш образ жизни навсегда.",
          "После десятилетий исследований ученым наконец удалось преодолеть казавшийся непреодолимым технологический барьер.",
          "Международный консорциум инвесторов вложил более 50 миллиардов долларов в разработку этой революционной технологии.",
          "Первые клинические испытания показали эффективность, превышающую 95%, что считалось невозможным еще пять лет назад.",
          "Технология основана на прорывных открытиях в квантовой физике, сделанных всего два года назад.",
          "Предварительные оценки показывают, что внедрение этой технологии может увеличить глобальный ВВП на 7% в течение первого десятилетия.",
          "Несмотря на этические опасения, большинство экспертов считают, что потенциальные выгоды значительно превышают риски.",
          "Это изобретение может стать решением нескольких глобальных проблем человечества одновременно.",
          "Разработчики утверждают, что технология готова к масштабному внедрению уже через три года.",
          "Ведущие страны мира начали разрабатывать новую правовую базу для регулирования использования этой технологии."
        ],
        categories: ["Нейроинтерфейсы", "Квантовые технологии", "Космическая колонизация", "Искусственный разум", "Биотехнологии", "Энергетика будущего"],
        sources: ["Future Science", "Quantum Reality", "Transhumanist Review", "Космический обозреватель", "BioTech Frontier"]
      },
      'far-future': {
        titles: [
          "Открыта технология пространственных червоточин для мгновенных межзвездных перемещений",
          "Создана первая искусственная планета в системе Альфа Центавра",
          "Разработан метод полного переноса сознания в цифровую форму",
          "Завершено строительство орбитального кольца вокруг Земли",
          "Создан первый искусственный сверхразум, превышающий совокупный интеллект человечества",
          "Разработана технология манипуляции гравитационными полями",
          "Представлена система терраформирования планет в промышленных масштабах",
          "Создан первый универсальный нанороботический конструктор материи",
          "Открыт способ генерации искусственных вселенных в лабораторных условиях",
          "Разработана технология полного контроля погоды в планетарном масштабе",
          "Создана первая автономная колония на Венере с искусственной атмосферой",
          "Представлена технология управления временными потоками",
          "Запущена первая межзвездная колонизационная миссия к экзопланетам",
          "Создан квантовый суперкомпьютер, способный симулировать целые галактики",
          "Разработана технология биологического бессмертия человека"
        ],
        descriptions: [
          "Этот прорыв открывает для человечества принципиально новую эру, сравнимую по значимости с выходом наших предков из океана на сушу.",
          "Технология, которая ещё недавно считалась нарушающей фундаментальные законы физики, теперь стала реальностью благодаря открытию новых принципов квантовой механики.",
          "Международный Галактический Консорциум выделил беспрецедентный бюджет в 10 триллионов кредитов на полномасштабное внедрение технологии.",
          "Система прошла десятилетние испытания на спутнике Юпитера и теперь готова к развертыванию в масштабах всей Солнечной системы.",
          "Эта технология может решить все энергетические, экологические и ресурсные проблемы человечества одним махом, открывая путь к настоящему изобилию.",
          "Ведущие философы и этики Галактического Совета обсуждают далеко идущие последствия этого открытия для будущего разумной жизни во Вселенной.",
          "Технология основана на принципиально новой парадигме взаимодействия с субквантовым уровнем реальности, открытой всего десятилетие назад.",
          "Это достижение становится финальным аккордом тысячелетней научно-технической эволюции человечества, выводя нас на уровень сил, ранее приписываемых только богам.",
          "Первые полевые испытания превзошли даже самые смелые теоретические прогнозы, демонстрируя эффективность в 1000 раз выше расчетной.",
          "Синтетические сверхразумы восьмого поколения предсказывают, что внедрение этой технологии приведет к формированию новой формы разумной жизни в течение ближайшего столетия."
        ],
        categories: ["Межзвездные путешествия", "Планетарная инженерия", "Сингулярность", "Постчеловеческие технологии", "Квантовая инженерия реальности", "Астроинженерия"],
        sources: ["Галактический вестник", "Хроники сингулярности", "Журнал трансцендентной науки", "Межзвездный обозреватель", "Постчеловеческие исследования"]
      }
    };

    // Выбираем соответствующий набор новостей для эпохи
    const epochData = newsByEpoch[epochType];
    
    // Генерируем от 5 до 12 новостей в зависимости от даты
    const seedBase = `${day}-${month}-${year}`;
    const newsCount = 5 + Math.abs(hashCode(seedBase)) % 8;
    
    // Выбираем уникальные заголовки и описания
    const selectedTitles = getMultipleRandomItems(epochData.titles, newsCount, `${seedBase}-titles`);
    const selectedDescriptions = getMultipleRandomItems(epochData.descriptions, newsCount, `${seedBase}-descs`);
    
    const generatedNews: NewsItem[] = [];

    for (let i = 0; i < newsCount; i++) {
      const seed = `${seedBase}-${i}`;
      const importance = 1 + Math.abs(hashCode(`${seed}-importance`)) % 5;
      
      generatedNews.push({
        id: i,
        title: selectedTitles[i],
        description: selectedDescriptions[i % selectedDescriptions.length],
        category: getRandomItem(epochData.categories, `${seed}-category`),
        source: getRandomItem(epochData.sources, `${seed}-source`),
        readTime: 2 + Math.abs(hashCode(`${seed}-time`)) % 8,
        importance: importance
      });
    }

    // Сортируем новости по важности (от наиболее важных к менее важным)
    return generatedNews.sort((a, b) => b.importance - a.importance);
  };

  if (loading) {
    return (
      <div className="space-y-4">
        <h2 className="text-2xl font-bold mb-6">Новости на {date}</h2>
        {[1, 2, 3, 4, 5].map((i) => (
          <Card key={i} className="mb-4">
            <CardHeader>
              <Skeleton className="h-6 w-3/4 mb-2" />
              <Skeleton className="h-4 w-1/4" />
            </CardHeader>
            <CardContent>
              <Skeleton className="h-20 w-full" />
            </CardContent>
            <CardFooter>
              <Skeleton className="h-4 w-1/2" />
            </CardFooter>
          </Card>
        ))}
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
        <div className="flex items-center text-red-700 mb-2">
          <AlertCircle className="h-5 w-5 mr-2" />
          <h3 className="font-bold">Ошибка</h3>
        </div>
        <p className="text-red-600">{error}</p>
      </div>
    );
  }

  const [, , yearStr] = date.split('.');
  const year = parseInt(yearStr);
  const epochType = getEpochType(year);
  
  // Определяем заголовок для разных эпох
  const epochTitles = {
    'ancient': "Вести старины",
    'pre-industrial': "Хроники ремесленников",
    'industrial': "Промышленный вестник",
    'modern': "Современные новости",
    'near-future': "Технологии ближнего будущего",
    'far-future': "Галактические хроники"
  };

  return (
    <div>
      <div className="mb-6 flex items-center justify-between">
        <h2 className="text-2xl font-bold flex items-center">
          <CalendarIcon className="mr-2 h-5 w-5 text-news-primary" />
          {epochTitles[epochType]} ({date})
        </h2>
        <p className="text-sm text-muted-foreground">Найдено {news.length} новостей</p>
      </div>
      
      <div className="space-y-4">
        {news.map((item) => (
          <Card key={item.id} 
            className={`mb-4 hover:shadow-md transition-shadow duration-200 border-l-4 ${
              item.importance >= 4 ? 'border-l-red-500' : 
              item.importance >= 3 ? 'border-l-amber-500' : 
              'border-l-news-primary'
            }`}
          >
            <CardHeader>
              <div className="flex justify-between items-start">
                <div>
                  <CardTitle className="text-xl hover:text-news-primary transition-colors">
                    {item.importance >= 4 && <span className="mr-2 text-red-500">⚠️</span>}
                    {item.title}
                  </CardTitle>
                  <CardDescription className="flex items-center mt-2">
                    <Globe className="h-4 w-4 mr-1" />
                    <span className="bg-news-accent text-news-secondary text-xs px-2 py-1 rounded-full mr-2">{item.category}</span>
                    <span className="text-xs text-muted-foreground">{item.source}</span>
                  </CardDescription>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <p className="text-gray-700">{item.description}</p>
            </CardContent>
            <CardFooter className="text-sm text-muted-foreground flex justify-between">
              <div className="flex items-center">
                <Clock className="h-4 w-4 mr-1" />
                <span>{item.readTime} мин. чтения</span>
              </div>
              <div className="flex space-x-4">
                <button className="flex items-center text-gray-600 hover:text-news-primary transition-colors">
                  <ThumbsUp className="h-4 w-4 mr-1" />
                  <span>Полезно</span>
                </button>
                <button className="flex items-center text-gray-600 hover:text-news-primary transition-colors">
                  <BookOpen className="h-4 w-4 mr-1" />
                  <span>Читать полностью</span>
                </button>
              </div>
            </CardFooter>
          </Card>
        ))}
      </div>
    </div>
  );
};
